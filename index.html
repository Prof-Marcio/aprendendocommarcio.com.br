<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA MESTRE 360 | CLOUD GOLD</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #10b981; --bg: #f1f5f9; --white: #ffffff; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; height: 100vh; margin: 0; color: #1e293b; overflow: hidden; }
        
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; }
        .status-cloud { font-size: 11px; color: var(--accent); margin-bottom: 20px; border: 1px solid var(--accent); padding: 8px; border-radius: 4px; text-align: center; background: rgba(16, 185, 129, 0.1); }
        
        main { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .nav-btn { width: 100%; padding: 12px; margin-bottom: 8px; border: none; border-radius: 8px; background: transparent; color: #94a3b8; text-align: left; cursor: pointer; transition: 0.3s; font-weight: 600; }
        .nav-btn.active { background: var(--accent); color: var(--primary); }
        .nav-btn:hover:not(.active) { background: rgba(255,255,255,0.05); color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        input:focus { border-color: var(--accent); }

        /* Estilo para as notas */
        .nota-input { width: 60px; text-align: center; font-weight: bold; }
        .media-bad { color: var(--danger); font-weight: bold; }
        .media-good { color: var(--accent); font-weight: bold; }

        /* Mapa de Sala */
        .grid-mapa { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 20px; }
        .assento { aspect-ratio: 1/1; border: 2px dashed #cbd5e1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; text-align: center; padding: 5px; }
        .assento.ocupado { border-style: solid; border-color: var(--primary); background: #f8fafc; }
    </style>
</head>
<body>

<aside>
    <h2 style="color: var(--accent); margin-bottom: 5px;">MESTRE 360</h2>
    <p style="font-size: 10px; margin-bottom: 20px; opacity: 0.7;">Versão Nuvem v2.0</p>
    <div id="cloud-info" class="status-cloud"><i class="fas fa-sync fa-spin"></i> Sincronizando...</div>
    
    <nav>
        <button class="nav-btn active" onclick="app.nav('turmas', this)"><i class="fas fa-school"></i> Turmas</button>
        <button class="nav-btn" onclick="app.nav('alunos', this)"><i class="fas fa-users"></i> Alunos</button>
        <button class="nav-btn" onclick="app.nav('notas', this)"><i class="fas fa-star"></i> Notas e Médias</button>
        <button class="nav-btn" onclick="app.nav('freq', this)"><i class="fas fa-check-double"></i> Frequência</button>
        <button class="nav-btn" onclick="app.nav('mapa', this)"><i class="fas fa-th"></i> Mapa de Sala</button>
    </nav>
</aside>

<main>
    <section id="turmas" class="section active">
        <div class="card">
            <h3>Gerenciar Turmas</h3>
            <div style="display:flex; gap:10px; margin: 20px 0;">
                <input type="text" id="in-turma" placeholder="Ex: 3º ANO C" style="flex:1">
                <button onclick="app.addTurma()" class="nav-btn" style="background:var(--primary); color:white; width:auto; padding: 0 25px;">Criar Turma</button>
            </div>
            <table id="tab-turmas">
                <thead><tr><th>Nome da Turma</th><th width="100">Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section id="alunos" class="section">
        <div class="card">
            <h3>Lista de Alunos: <select id="sel-turma-alunos" onchange="app.renderAlunos()"></select></h3>
            <table id="tab-alunos">
                <thead><tr><th width="50">Nº</th><th>Nome do Aluno</th></tr></thead>
                <tbody id="lista-alunos"></tbody>
            </table>
        </div>
    </section>

    <section id="notas" class="section">
        <div class="card">
            <h3>Notas e Médias: <select id="sel-turma-notas" onchange="app.renderNotas()"></select></h3>
            <table id="tab-notas">
                <thead><tr><th>Aluno</th><th>AV1</th><th>AV2</th><th>TRAB</th><th>MÉDIA</th></tr></thead>
                <tbody id="lista-notas"></tbody>
            </table>
        </div>
    </section>

    <section id="freq" class="section">
        <div class="card">
            <h3>Chamada Online: <select id="sel-turma-freq" onchange="app.renderFreq()"></select></h3>
            <div id="corpo-freq">Selecione uma turma...</div>
        </div>
    </section>

    <section id="mapa" class="section">
        <div class="card">
            <h3>Mapa de Sala: <select id="sel-turma-mapa" onchange="app.renderMapa()"></select></h3>
            <div class="grid-mapa" id="grid-mapa"></div>
        </div>
    </section>
</main>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAn1Eja_qa81xRhzn3lYy_X7t7ML2DKxkg",
    authDomain: "mestre-360.firebaseapp.com",
    databaseURL: "https://mestre-360-default-rtdb.firebaseio.com",
    projectId: "mestre-360",
    storageBucket: "mestre-360.firebasestorage.app",
    messagingSenderId: "894952532346",
    appId: "1:894952532346:web:881d00bdc0f6ffd6a38ec3"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const app = {
    db: { turmas: {} },

    init() {
        database.ref('mestre360_data').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) this.db = data;
            this.updateUI();
            document.getElementById('cloud-info').innerHTML = '<i class="fas fa-cloud"></i> Google Cloud: Ativo';
        }, error => {
            alert("Erro de Permissão: Verifique se ativou o 'Modo de Teste' nas Regras do Firebase.");
        });
    },

    save() {
        database.ref('mestre360_data').set(this.db)
            .catch(e => alert("Falha ao salvar: " + e.message));
    },

    nav(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        this.updateUI();
    },

    // TURMAS
    addTurma() {
        const input = document.getElementById('in-turma');
        const nome = input.value.trim().toUpperCase();
        if(!nome) return;
        if(!this.db.turmas[nome]) {
            this.db.turmas[nome] = { alunos: {}, notas: {}, freq: {} };
            this.save();
            input.value = "";
        }
    },

    delTurma(t) { if(confirm(`Excluir a turma ${t}?`)) { delete this.db.turmas[t]; this.save(); } },

    // RENDERIZADORES
    updateUI() {
        this.renderTurmasList();
        this.syncSelectors();
        // Atualiza a seção atual
        if(document.getElementById('alunos').classList.contains('active')) this.renderAlunos();
        if(document.getElementById('notas').classList.contains('active')) this.renderNotas();
        if(document.getElementById('mapa').classList.contains('active')) this.renderMapa();
    },

    renderTurmasList() {
        const tbody = document.querySelector('#tab-turmas tbody');
        tbody.innerHTML = Object.keys(this.db.turmas).map(t => `
            <tr><td><strong>${t}</strong></td>
            <td><button onclick="app.delTurma('${t}')" style="color:var(--danger); border:none; background:none; cursor:pointer;"><i class="fas fa-trash-alt"></i></button></td></tr>
        `).join('');
    },

    syncSelectors() {
        const selects = ['sel-turma-alunos', 'sel-turma-freq', 'sel-turma-notas', 'sel-turma-mapa'];
        const options = '<option value="">Selecione a Turma...</option>' + Object.keys(this.db.turmas).map(t => `<option value="${t}">${t}</option>`).join('');
        selects.forEach(s => {
            const el = document.getElementById(s);
            const val = el.value;
            el.innerHTML = options;
            el.value = val;
        });
    },

    renderAlunos() {
        const t = document.getElementById('sel-turma-alunos').value;
        const body = document.getElementById('lista-alunos');
        body.innerHTML = ""; if(!t) return;
        for(let i=1; i<=40; i++) {
            const nome = this.db.turmas[t].alunos[i] || "";
            body.innerHTML += `<tr><td>${i}</td><td><input type="text" value="${nome}" onchange="app.upStudent('${t}',${i},this.value)" style="width:100%"></td></tr>`;
        }
    },

    upStudent(t, i, v) { 
        if(!this.db.turmas[t].alunos) this.db.turmas[t].alunos = {};
        this.db.turmas[t].alunos[i] = v.toUpperCase(); 
        this.save(); 
    },

    // NOTAS
    renderNotas() {
        const t = document.getElementById('sel-turma-notas').value;
        const body = document.getElementById('lista-notas');
        body.innerHTML = ""; if(!t) return;
        Object.entries(this.db.turmas[t].alunos).forEach(([i, nome]) => {
            if(!nome) return;
            const n = (this.db.turmas[t].notas && this.db.turmas[t].notas[i]) ? this.db.turmas[t].notas[i] : {a1:0, a2:0, tr:0};
            const media = ((parseFloat(n.a1)||0) + (parseFloat(n.a2)||0) + (parseFloat(n.tr)||0)) / 3;
            body.innerHTML += `<tr>
                <td>${nome}</td>
                <td><input type="number" class="nota-input" value="${n.a1}" onchange="app.upNota('${t}',${i},'a1',this.value)"></td>
                <td><input type="number" class="nota-input" value="${n.a2}" onchange="app.upNota('${t}',${i},'a2',this.value)"></td>
                <td><input type="number" class="nota-input" value="${n.tr}" onchange="app.upNota('${t}',${i},'tr',this.value)"></td>
                <td class="${media >= 6 ? 'media-good' : 'media-bad'}">${media.toFixed(1)}</td>
            </tr>`;
        });
    },

    upNota(t, i, campo, valor) {
        if(!this.db.turmas[t].notas) this.db.turmas[t].notas = {};
        if(!this.db.turmas[t].notas[i]) this.db.turmas[t].notas[i] = {a1:0, a2:0, tr:0};
        this.db.turmas[t].notas[i][campo] = valor;
        this.save();
    },

    // FREQUÊNCIA
    renderFreq() {
        const t = document.getElementById('sel-turma-freq').value;
        const corpo = document.getElementById('corpo-freq');
        if(!t) return;
        corpo.innerHTML = `<table><thead><tr><th>Aluno</th><th>Presença</th></tr></thead><tbody>
            ${Object.entries(this.db.turmas[t].alunos).filter(a => a[1]).map(([i, nome]) => `
                <tr><td>${nome}</td><td><input type="checkbox"></td></tr>
            `).join('')}
        </tbody></table>`;
    },

    // MAPA
    renderMapa() {
        const t = document.getElementById('sel-turma-mapa').value;
        const grid = document.getElementById('grid-mapa');
        grid.innerHTML = ""; if(!t) return;
        for(let i=1; i<=30; i++) {
            const aluno = this.db.turmas[t].alunos[i] || "";
            grid.innerHTML += `<div class="assento ${aluno ? 'ocupado' : ''}">
                <i class="fas fa-chair"></i><br>${aluno ? aluno.split(' ')[0] : i}
            </div>`;
        }
    }
};

app.init();
</script>
</body>
</html>