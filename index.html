<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA MESTRE 360 | NUVEM GOOGLE</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #1a3059; 
            --accent: #4caf50;  
            --accent-hover: #2e7d32;
            --bg: #f1f5f9; 
            --white: #ffffff; 
            --danger: #e11d48; 
            --text: #1e293b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; color: var(--text); }
        
        aside { width: 280px; background: var(--primary); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 20px rgba(0,0,0,0.2); z-index: 100; }
        .aside-header { padding: 30px 20px; text-align: center; border-bottom: 2px solid var(--accent); background: rgba(0,0,0,0.2); }
        .logo-box { width: 80px; height: 80px; background: white; border-radius: 15px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; border: 3px solid var(--accent); overflow: hidden;}
        .logo-box img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .status-cloud { font-size: 10px; color: var(--accent); margin-top: 10px; font-weight: bold; }
        
        .nav-group { padding: 25px 20px 5px; font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: 800; letter-spacing: 2px; }
        .nav-item { width: 90%; margin: 2px auto; padding: 12px 15px; background: none; border: none; color: #cbd5e1; display: flex; align-items: center; gap: 12px; cursor: pointer; border-radius: 10px; transition: 0.3s; text-align: left; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--accent); }
        .nav-item.active { background: var(--accent); color: var(--primary); font-weight: 700; }

        main { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header-box { background: var(--white); padding: 20px 30px; border-radius: 15px; margin-bottom: 25px; display: flex; align-items: center; justify-content: space-between; border-left: 8px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card { background: var(--white); padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 25px; border: 1px solid #e2e8f0; }

        input, select, textarea { padding: 12px; border-radius: 8px; border: 1.5px solid #cbd5e1; outline: none; }
        .btn-acao { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; background: var(--primary); color: white; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-acao:hover { background: var(--accent); color: var(--primary); }

        .grade-mapeamento { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; background: #e2e8f0; padding: 20px; border-radius: 15px; margin-top: 20px; }
        .carteira { aspect-ratio: 1/1.2; background: white; border: 2px dashed #cbd5e1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; transition: 0.2s; }
        .carteira.ocupada { border-style: solid; border-color: var(--primary); }
        .carteira img { width: 100%; height: 75%; object-fit: cover; }
        .carteira span { font-size: 9px; font-weight: 800; text-align: center; padding: 4px; color: var(--primary); width: 100%; overflow: hidden; text-overflow: ellipsis; }
        
        .mesa-professor { grid-column: span 7; background: var(--primary); color: white; text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: 800; letter-spacing: 5px; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 15px; font-size: 11px; color: var(--primary); text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .col-fixa { position: sticky; left: 0; background: white; z-index: 5; text-align: left; font-weight: bold; min-width: 150px; }

        #visor-modal, #modal-mapa { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; }
        .visor-content { width: 90%; height: 90%; display: flex; align-items: center; justify-content: center; }
        .btn-fechar { position: absolute; top: 20px; right: 20px; background: var(--danger); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }

        .grid-midia { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .midia-card { background: white; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0; cursor: pointer; }
    </style>
</head>
<body>

<aside>
    <div class="aside-header">
        <div class="logo-box"><img src="logo-marcio.png"></div>
        <h2>MESTRE 360</h2>
        <div id="cloud-status" class="status-cloud">Sincronizando...</div>
    </div>

    <div class="nav-group">Gestão</div>
    <button class="nav-item active" onclick="nav('config', this)"><i class="fas fa-chalkboard"></i> Turmas</button>
    <button class="nav-item" onclick="nav('cadastro', this)"><i class="fas fa-users"></i> Alunos</button>
    <button class="nav-item" onclick="nav('mapeamento', this)"><i class="fas fa-th"></i> Mapeamento Sala</button>
    
    <div class="nav-group">Diário</div>
    <button class="nav-item" onclick="nav('freq', this)"><i class="fas fa-check-double"></i> Frequência</button>
    <button class="nav-item" onclick="nav('notas', this)"><i class="fas fa-graduation-cap"></i> Notas</button>
    
    <div class="nav-group">Aula Show</div>
    <button class="nav-item" onclick="nav('projetos', this)"><i class="fas fa-file-alt"></i> Roteiro & Anexos</button>
    <button class="nav-item" onclick="nav('apresentacao', this)"><i class="fas fa-tv"></i> Modo TV</button>
</aside>

<main>
    <section id="config" class="section active">
        <div class="header-box"><h1>Minhas Turmas</h1></div>
        <div class="card">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="nome-turma" placeholder="Ex: 1º ANO A" style="flex:1">
                <button class="btn-acao" onclick="addTurma()"><i class="fas fa-plus"></i> CRIAR TURMA</button>
            </div>
            <table>
                <thead><tr><th>TURMA</th><th width="100">AÇÃO</th></tr></thead>
                <tbody id="corpo-turmas"></tbody>
            </table>
        </div>
    </section>

    <section id="cadastro" class="section">
        <div class="header-box"><h1>Alunos</h1><select id="sel-t-cadastro" onchange="renderAlunos()"></select></div>
        <div class="card">
            <table>
                <thead><tr><th width="50">Nº</th><th>NOME COMPLETO DO ALUNO</th></tr></thead>
                <tbody id="corpo-alunos"></tbody>
            </table>
        </div>
    </section>

    <section id="mapeamento" class="section">
        <div class="header-box"><h1>Mapeamento</h1><select id="sel-t-map" onchange="renderMapeamento()"></select></div>
        <div class="card">
            <div class="mesa-professor">QUADRO / MESA DO PROFESSOR</div>
            <div class="grade-mapeamento" id="grade-sala"></div>
        </div>
    </section>

    <section id="freq" class="section">
        <div class="header-box">
            <h1>Frequência</h1>
            <select id="sel-t-freq" onchange="renderFreq()"></select>
            <input type="date" id="data-aula">
            <button class="btn-acao" onclick="novaData()"><i class="fas fa-calendar-plus"></i></button>
        </div>
        <div class="card" style="overflow-x:auto">
            <table><thead id="head-freq"></thead><tbody id="corpo-freq"></tbody></table>
        </div>
    </section>

    <section id="notas" class="section">
        <div class="header-box"><h1>Notas</h1><select id="sel-t-notas" onchange="renderNotas()"></select></div>
        <div class="card">
            <table>
                <thead><tr><th class="col-fixa">ALUNO</th><th>AV1</th><th>AV2</th><th>TRAB</th><th>MÉDIA</th></tr></thead>
                <tbody id="corpo-notas"></tbody>
            </table>
        </div>
    </section>

    <section id="projetos" class="section">
        <div class="header-box"><h1>Roteiro</h1><select id="sel-t-proj" onchange="carregarPlano()"></select></div>
        <div class="card">
            <textarea id="texto-plano" style="height:150px; width:100%; margin-bottom:15px;" placeholder="Destaque da aula na TV..."></textarea>
            <div style="display:flex; gap:10px; background:#f8fafc; padding:15px; border-radius:10px;">
                <input type="file" id="file-roteiro" style="flex:1">
                <button class="btn-acao" onclick="uploadArqRoteiro()">ANEXAR</button>
            </div>
            <div class="grid-midia" id="anexos-roteiro-container" style="margin-top:20px"></div>
            <button class="btn-acao" style="width:100%; margin-top:20px" onclick="salvarPlano()">SALVAR NO GOOGLE</button>
        </div>
    </section>

    <section id="apresentacao" class="section">
        <div class="header-box"><select id="sel-t-apr" onchange="renderTV()"></select><button class="btn-acao" onclick="toggleFull()">TELA CHEIA</button></div>
        <div class="card" id="painel-tv" style="background:#0f172a; color:white; text-align:center; min-height:400px; display:flex; flex-direction:column; justify-content:center; padding:40px; border-radius:20px">
            <h1 id="tv-titulo" style="color:var(--accent); font-size:50px">SISTEMA MESTRE 360</h1>
            <p id="tv-texto" style="font-size:24px; margin-top:20px"></p>
        </div>
        <div class="grid-midia" id="tv-midias-bar" style="margin-top:20px"></div>
    </section>
</main>

<div id="modal-mapa">
    <div class="card" style="width:350px">
        <h3 id="info-posicao"></h3><br>
        <select id="select-aluno-mapa" style="width:100%; margin-bottom:10px"></select>
        <input type="file" id="foto-aluno-input" accept="image/*" style="width:100%">
        <div style="display:flex; gap:10px; margin-top:20px">
            <button class="btn-acao" onclick="salvarCarteira()">SALVAR</button>
            <button class="btn-acao" style="background:var(--danger)" onclick="limparCarteira()">LIMPAR</button>
            <button class="btn-acao" style="background:#666" onclick="fecharModalMapa()">X</button>
        </div>
    </div>
</div>

<div id="visor-modal">
    <button class="btn-fechar" onclick="fecharVisor()">X</button>
    <div class="visor-content" id="visor-alvo"></div>
</div>

<script>
    // CONFIGURAÇÃO FIREBASE DO PROFESSOR
    const firebaseConfig = {
        apiKey: "AIzaSyAn1Eja_qa81xRhzn3lYy_X7t7ML2DKxkg",
        authDomain: "mestre-360.firebaseapp.com",
        databaseURL: "https://mestre-360-default-rtdb.firebaseio.com",
        projectId: "mestre-360",
        storageBucket: "mestre-360.firebasestorage.app",
        messagingSenderId: "894952532346",
        appId: "1:894952532346:web:881d00bdc0f6ffd6a38ec3"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let db = { turmas: {} };

    // INICIAR CONEXÃO
    function init() {
        database.ref('mestre360_data').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) db = data;
            document.getElementById('cloud-status').innerText = "● GOOGLE CLOUD ATIVO";
            povoarSelects();
            renderTurmas();
            // Atualiza a tela atual se necessário
            const activeId = document.querySelector('.section.active').id;
            nav(activeId);
        });
    }

    function salvar() {
        database.ref('mestre360_data').set(db);
    }

    function nav(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(btn) btn.classList.add('active');
        
        if(id === 'config') renderTurmas();
        if(id === 'cadastro') renderAlunos();
        if(id === 'mapeamento') renderMapeamento();
        if(id === 'freq') renderFreq();
        if(id === 'notas') renderNotas();
        if(id === 'projetos') carregarPlano();
        if(id === 'apresentacao') renderTV();
    }

    // FUNÇÕES DE TURMA
    function addTurma() {
        let n = document.getElementById('nome-turma').value.trim().toUpperCase();
        if(n && !db.turmas[n]) {
            db.turmas[n] = { alunos: {}, chamadas: {}, notas: {}, plano: "", anexos: [], mapa: {} };
            salvar();
            document.getElementById('nome-turma').value = "";
        }
    }
    function renderTurmas() {
        document.getElementById('corpo-turmas').innerHTML = Object.keys(db.turmas || {}).map(t => 
            `<tr><td>${t}</td><td><button onclick="delTurma('${t}')" class="btn-acao" style="background:var(--danger)">X</button></td></tr>`
        ).join('');
    }
    function delTurma(t) { if(confirm("Apagar turma permanentemente no Google?")) { delete db.turmas[t]; salvar(); } }

    // ALUNOS
    function renderAlunos() {
        const t = document.getElementById('sel-t-cadastro').value;
        const corpo = document.getElementById('corpo-alunos');
        corpo.innerHTML = ''; if(!t) return;
        for(let i=1; i<=45; i++){
            let nome = (db.turmas[t].alunos && db.turmas[t].alunos[i]) || '';
            corpo.innerHTML += `<tr><td>${i}</td><td><input type="text" value="${nome}" style="width:100%" onchange="upAlu('${t}',${i},this.value)"></td></tr>`;
        }
    }
    function upAlu(t, i, v) { if(!db.turmas[t].alunos) db.turmas[t].alunos = {}; db.turmas[t].alunos[i] = v.toUpperCase(); salvar(); }

    // MAPEAMENTO
    let posAtual = null;
    function renderMapeamento() {
        const t = document.getElementById('sel-t-map').value;
        const grade = document.getElementById('grade-sala');
        grade.innerHTML = ''; if(!t) return;
        for(let i=1; i<=49; i++) {
            const dados = db.turmas[t].mapa ? db.turmas[t].mapa[i] : null;
            let html = `<div class="carteira ${dados?'ocupada':''}" onclick="abrirModalMapa(${i})">`;
            if(dados && dados.foto) html += `<img src="${dados.foto}"><span>${dados.nome}</span>`;
            else if(dados) html += `<i class="fas fa-user-graduate" style="font-size:20px; margin-bottom:5px"></i><span>${dados.nome}</span>`;
            else html += `<span>${i}</span>`;
            grade.innerHTML += html + `</div>`;
        }
    }
    function abrirModalMapa(pos) {
        const t = document.getElementById('sel-t-map').value;
        if(!t) return alert("Selecione a turma");
        posAtual = pos;
        document.getElementById('info-posicao').innerText = "Carteira " + pos;
        const sel = document.getElementById('select-aluno-mapa');
        sel.innerHTML = '<option value="">Vazio</option>';
        if(db.turmas[t].alunos) {
            Object.keys(db.turmas[t].alunos).forEach(n => {
                if(db.turmas[t].alunos[n]) sel.innerHTML += `<option value="${n}">${db.turmas[t].alunos[n]}</option>`;
            });
        }
        document.getElementById('modal-mapa').style.display = 'flex';
    }
    function fecharModalMapa() { document.getElementById('modal-mapa').style.display = 'none'; }
    function salvarCarteira() {
        const t = document.getElementById('sel-t-map').value;
        const num = document.getElementById('select-aluno-mapa').value;
        const file = document.getElementById('foto-aluno-input').files[0];
        if(!db.turmas[t].mapa) db.turmas[t].mapa = {};
        if(!num) { delete db.turmas[t].mapa[posAtual]; salvar(); fecharModalMapa(); return; }
        const nome = db.turmas[t].alunos[num];
        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => { db.turmas[t].mapa[posAtual] = { num, nome, foto: e.target.result }; salvar(); fecharModalMapa(); };
            reader.readAsDataURL(file);
        } else {
            db.turmas[t].mapa[posAtual] = { num, nome, foto: db.turmas[t].mapa[posAtual]?.foto || null };
            salvar(); fecharModalMapa();
        }
    }
    function limparCarteira() { const t = document.getElementById('sel-t-map').value; delete db.turmas[t].mapa[posAtual]; salvar(); fecharModalMapa(); }

    // FREQUENCIA
    function novaData() {
        const t = document.getElementById('sel-t-freq').value;
        const d = document.getElementById('data-aula').value;
        if(t && d) { if(!db.turmas[t].chamadas) db.turmas[t].chamadas = {}; db.turmas[t].chamadas[d] = {}; salvar(); }
    }
    function renderFreq() {
        const t = document.getElementById('sel-t-freq').value;
        if(!t || !db.turmas[t].chamadas) return;
        const dias = Object.keys(db.turmas[t].chamadas).sort();
        document.getElementById('head-freq').innerHTML = `<tr><th class="col-fixa">ALUNO</th>${dias.map(d=>`<th>${d.split('-').reverse().slice(0,2).join('/')}</th>`).join('')}</tr>`;
        document.getElementById('corpo-freq').innerHTML = Object.keys(db.turmas[t].alunos || {}).filter(k=>db.turmas[t].alunos[k]).map(n => {
            let row = `<tr><td class="col-fixa">${db.turmas[t].alunos[n]}</td>`;
            dias.forEach(d => {
                let s = db.turmas[t].chamadas[d][n] || 'P';
                row += `<td><button onclick="toggleF('${t}','${d}','${n}')" style="background:${s==='P'?'#dcfce7':'#fee2e2'}; border:none; padding:5px; border-radius:4px; cursor:pointer">${s}</button></td>`;
            });
            return row + `</tr>`;
        }).join('');
    }
    function toggleF(t,d,n) { db.turmas[t].chamadas[d][n] = (db.turmas[t].chamadas[d][n] || 'P') === 'P' ? 'F' : 'P'; salvar(); }

    // NOTAS
    function renderNotas() {
        const t = document.getElementById('sel-t-notas').value;
        if(!t) return;
        if(!db.turmas[t].notas) db.turmas[t].notas = {};
        document.getElementById('corpo-notas').innerHTML = Object.keys(db.turmas[t].alunos || {}).filter(k=>db.turmas[t].alunos[k]).map(n => {
            let nt = db.turmas[t].notas[n] || {a1:0, a2:0, tr:0};
            let med = ((parseFloat(nt.a1)||0) + (parseFloat(nt.a2)||0) + (parseFloat(nt.tr)||0));
            return `<tr><td class="col-fixa">${db.turmas[t].alunos[n]}</td>
                <td><input type="number" value="${nt.a1}" onchange="upN('${t}','${n}','a1',this.value)"></td>
                <td><input type="number" value="${nt.a2}" onchange="upN('${t}','${n}','a2',this.value)"></td>
                <td><input type="number" value="${nt.tr}" onchange="upN('${t}','${n}','tr',this.value)"></td>
                <td><b>${med.toFixed(1)}</b></td></tr>`;
        }).join('');
    }
    function upN(t,n,f,v) { if(!db.turmas[t].notas[n]) db.turmas[t].notas[n] = {a1:0, a2:0, tr:0}; db.turmas[t].notas[n][f] = v; salvar(); }

    // ROTEIRO E MODO TV
    function uploadArqRoteiro() {
        const t = document.getElementById('sel-t-proj').value;
        const file = document.getElementById('file-roteiro').files[0];
        if(!t || !file) return;
        const reader = new FileReader();
        reader.onload = (e) => { 
            if(!db.turmas[t].anexos) db.turmas[t].anexos = [];
            db.turmas[t].anexos.push({ n: file.name, t: file.type, d: e.target.result }); 
            salvar(); 
        };
        reader.readAsDataURL(file);
    }
    function renderAnexosRoteiro() {
        const t = document.getElementById('sel-t-proj').value;
        const container = document.getElementById('anexos-roteiro-container');
        container.innerHTML = (db.turmas[t]?.anexos || []).map((a, i) => `
            <div class="midia-card">
                <i class="fas ${a.t.includes('pdf')?'fa-file-pdf':'fa-file-image'}"></i>
                <p style="font-size:9px">${a.n.substring(0,10)}</p>
                <button onclick="db.turmas['${t}'].anexos.splice(${i},1); salvar()" style="background:var(--danger); color:white; border:none; padding:2px 5px; border-radius:3px">X</button>
            </div>`).join('');
    }
    function carregarPlano() {
        const t = document.getElementById('sel-t-proj').value;
        document.getElementById('texto-plano').value = db.turmas[t]?.plano || "";
        renderAnexosRoteiro();
    }
    function salvarPlano() {
        const t = document.getElementById('sel-t-proj').value;
        if(t) { db.turmas[t].plano = document.getElementById('texto-plano').value; salvar(); alert("Salvo no Google!"); }
    }
    function renderTV() {
        const t = document.getElementById('sel-t-apr').value;
        if(!t) return;
        document.getElementById('tv-titulo').innerText = t;
        document.getElementById('tv-texto').innerText = db.turmas[t].plano || "Nenhum roteiro definido.";
        document.getElementById('tv-midias-bar').innerHTML = (db.turmas[t].anexos || []).map((a, i) => `
            <div class="midia-card" onclick="verAnexo('${t}',${i})"><i class="fas fa-file"></i><p>${a.n}</p></div>`).join('');
    }
    function verAnexo(t, i) {
        const a = db.turmas[t].anexos[i];
        const v = document.getElementById('visor-alvo');
        document.getElementById('visor-modal').style.display = 'flex';
        if(a.t.includes('image')) v.innerHTML = `<img src="${a.d}" style="max-width:100%; max-height:100%">`;
        else v.innerHTML = `<iframe src="${a.d}" width="100%" height="100%"></iframe>`;
    }
    function fecharVisor() { document.getElementById('visor-modal').style.display = 'none'; }

    // UTILS
    function povoarSelects() {
        const ids = ['sel-t-cadastro','sel-t-freq','sel-t-notas','sel-t-proj','sel-t-apr', 'sel-t-map'];
        const opt = `<option value="">TURMA...</option>` + Object.keys(db.turmas || {}).sort().map(t => `<option value="${t}">${t}</option>`).join('');
        ids.forEach(id => { 
            const s = document.getElementById(id); 
            if(s) { let v = s.value; s.innerHTML = opt; s.value = v; } 
        });
    }
    function toggleFull() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

    init();
</script>
</body>
</html>